import React, { useState, useRef, useEffect } from 'react';

export default function GolfCoachApp() {
  const [apiKey, setApiKey] = useState('');
  const [videoFile, setVideoFile] = useState(null);
  const [videoPreview, setVideoPreview] = useState(null);
  const [capturedFrame, setCapturedFrame] = useState(null);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [analysis, setAnalysis] = useState(null);
  const [error, setError] = useState(null);
  const [showApiKeyInput, setShowApiKeyInput] = useState(true);
  const [debugInfo, setDebugInfo] = useState('');
  const fileInputRef = useRef(null);
  const videoRef = useRef(null);

  useEffect(() => {
    const savedKey = localStorage.getItem('gemini_api_key');
    if (savedKey) {
      setApiKey(savedKey);
      setShowApiKeyInput(false);
    }
  }, []);

  const saveApiKey = () => {
    if (apiKey.trim()) {
      localStorage.setItem('gemini_api_key', apiKey.trim());
      setShowApiKeyInput(false);
      setError(null);
    } else {
      setError('Please enter a valid API key');
    }
  };

  const changeApiKey = () => {
    setShowApiKeyInput(true);
    setAnalysis(null);
    setVideoFile(null);
    setVideoPreview(null);
    setCapturedFrame(null);
    setDebugInfo('');
    setError(null);
  };

  const handleFileSelect = (e) => {
    const file = e.target.files[0];
    if (file && file.type.startsWith('video/')) {
      setVideoFile(file);
      const url = URL.createObjectURL(file);
      setVideoPreview(url);
      setError(null);
      setAnalysis(null);
      setCapturedFrame(null);
      setDebugInfo(`Video loaded: ${file.name}`);
    } else {
      setError('Please select a valid video file');
    }
  };

  const captureFrame = () => {
    if (!videoRef.current) return null;
    
    const video = videoRef.current;
    if (video.readyState < 2) return null;
    
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    return canvas.toDataURL('image/jpeg', 0.8);
  };

  const analyzeSwing = async () => {
    if (!videoFile) {
      setError('Please upload a video first');
      return;
    }
    if (!apiKey) {
      setError('Please enter your API key first');
      setShowApiKeyInput(true);
      return;
    }

    setIsAnalyzing(true);
    setError(null);
    setDebugInfo('ðŸ“¸ Capturing frame from video...');

    try {
      const frameData = captureFrame();
      if (!frameData) {
        throw new Error('Could not capture frame. Play the video briefly, pause it, then try again.');
      }

      setCapturedFrame(frameData);
      const base64Image = frameData.split(',')[1];
      
      setDebugInfo('ðŸš€ Analyzing with Gemini 3.0 Flash...');

      // Use the newest Gemini 3.0 Flash model
      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-3.0-flash-exp:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            contents: [{
              parts: [
                {
                  inline_data: {
                    mime_type: 'image/jpeg',
                    data: base64Image
                  }
                },
                {
                  text: 'You are a PGA golf instructor. Analyze this golf swing position from the image. Provide feedback in JSON format only (no markdown, no backticks):\n\n{"analysis": "2-3 sentences about posture, stance, grip, and swing position", "issues": ["specific issue 1", "specific issue 2"], "drills": [{"name": "drill name", "purpose": "what it fixes", "steps": ["step 1", "step 2", "step 3"], "frequency": "recommendation"}]}\n\nFocus on position, posture, and form visible in the frame. Return ONLY the JSON.'
                }
              ]
            }]
          })
        }
      );

      setDebugInfo(`Response: ${response.status}`);

      if (!response.ok) {
        const errorText = await response.text();
        console.error('API Error:', errorText);
        
        if (response.status === 404) {
          throw new Error('Model not found. Gemini 3.0 might not be available yet with your API key. Try creating a fresh API key at aistudio.google.com/app/apikey');
        }
        
        throw new Error(`API Error (${response.status})`);
      }

      const data = await response.json();
      
      if (data.candidates
