<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SwingIQ - Gemini 2.5 Flash</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-white min-h-screen p-8">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-4xl font-bold text-emerald-400 mb-8 text-center">SwingIQ - Gemini 2.5 Flash</h1>
    
    <div id="keyInput" class="max-w-md mx-auto bg-slate-800 p-6 rounded-xl mb-8">
      <label class="block text-sm font-semibold mb-2">Gemini API Key</label>
      <input 
        id="apiKey" 
        type="text" 
        placeholder="AIza..." 
        class="w-full px-4 py-3 bg-slate-900 border border-slate-700 rounded-lg text-white mb-4"
      />
      <button onclick="saveKey()" class="w-full py-3 bg-emerald-600 hover:bg-emerald-700 rounded-lg font-semibold">
        Save Key
      </button>
      <p class="text-xs text-slate-500 mt-3">Get free key: aistudio.google.com/app/apikey</p>
    </div>

    <div id="app" class="hidden">
      <div class="bg-slate-800 rounded-2xl p-6 mb-6">
        <input type="file" id="videoInput" accept="video/*" class="hidden" onchange="loadVideo(event)"/>
        <div id="uploadArea" onclick="document.getElementById('videoInput').click()" class="p-16 text-center cursor-pointer hover:bg-slate-700 rounded-xl">
          <p class="text-xl mb-2">Upload Golf Swing Video</p>
          <p class="text-sm text-slate-400">Click to select</p>
        </div>
        <div id="videoArea" class="hidden">
          <video id="videoPlayer" controls playsinline class="w-full rounded-xl mb-4 bg-black" style="max-height: 500px"></video>
          <p class="text-sm text-blue-400 mb-4">ðŸ’¡ Pause at key position, then click Analyze</p>
          <div class="flex gap-3">
            <button onclick="document.getElementById('videoInput').click()" class="flex-1 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl">
              Change Video
            </button>
            <button onclick="analyzeSwing()" id="analyzeBtn" class="flex-1 py-3 bg-emerald-600 hover:bg-emerald-700 rounded-xl font-semibold">
              Analyze Frame
            </button>
          </div>
        </div>
      </div>

      <div id="debug" class="bg-slate-800 rounded-xl p-4 mb-6 hidden">
        <p id="debugText" class="text-sm text-slate-400 font-mono"></p>
      </div>

      <div id="error" class="bg-red-500/10 border border-red-500/30 rounded-xl p-4 mb-6 hidden">
        <p id="errorText" class="text-red-300 text-sm"></p>
      </div>

      <div id="results" class="hidden space-y-6">
        <div id="frameDisplay" class="bg-slate-800 rounded-2xl p-6 hidden">
          <h3 class="text-lg font-semibold mb-4">Analyzed Frame:</h3>
          <img id="frameImg" class="w-full rounded-xl" alt="Frame"/>
        </div>

        <div class="bg-slate-800 rounded-2xl p-6">
          <h2 class="text-xl font-bold text-emerald-400 mb-3">Analysis</h2>
          <p id="analysisText" class="text-slate-300"></p>
        </div>

        <div class="bg-slate-800 rounded-2xl p-6">
          <h2 class="text-xl font-bold text-amber-400 mb-3">Issues</h2>
          <div id="issuesList"></div>
        </div>

        <div class="bg-slate-800 rounded-2xl p-6">
          <h2 class="text-xl font-bold text-blue-400 mb-3">Drills</h2>
          <div id="drillsList"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let apiKey = localStorage.getItem('gemini_key');
    
    if (apiKey) {
      document.getElementById('keyInput').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
    }

    function saveKey() {
      const key = document.getElementById('apiKey').value.trim();
      if (key) {
        localStorage.setItem('gemini_key', key);
        apiKey = key;
        document.getElementById('keyInput').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
      }
    }

    function loadVideo(e) {
      const file = e.target.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        document.getElementById('videoPlayer').src = url;
        document.getElementById('uploadArea').classList.add('hidden');
        document.getElementById('videoArea').classList.remove('hidden');
        showDebug('Video loaded: ' + file.name);
      }
    }

    function showDebug(msg) {
      document.getElementById('debug').classList.remove('hidden');
      document.getElementById('debugText').textContent = msg;
    }

    function showError(msg) {
      document.getElementById('error').classList.remove('hidden');
      document.getElementById('errorText').textContent = msg;
    }

    function hideError() {
      document.getElementById('error').classList.add('hidden');
    }

    async function analyzeSwing() {
      hideError();
      const video = document.getElementById('videoPlayer');
      const btn = document.getElementById('analyzeBtn');
      
      btn.disabled = true;
      btn.textContent = 'Analyzing...';
      showDebug('Capturing frame...');

      try {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        const frameData = canvas.toDataURL('image/jpeg', 0.8);
        const b64 = frameData.split(',')[1];

        document.getElementById('frameImg').src = frameData;
        document.getElementById('frameDisplay').classList.remove('hidden');

        showDebug('Sending to Gemini 2.5 Flash API...');

        const response = await fetch(
          'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=' + apiKey,
          {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              contents: [{
                parts: [
                  {inline_data: {mime_type: 'image/jpeg', data: b64}},
                  {text: 'Golf coach: analyze this swing. JSON only: {"analysis": "2 sentences", "issues": ["issue 1", "issue 2"], "drills": [{"name": "drill", "purpose": "fix", "steps": ["s1", "s2", "s3"], "frequency": "daily"}]}'}
                ]
              }]
            })
          }
        );

        showDebug('Response: ' + response.status);

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error('API failed (' + response.status + '): ' + errorText.substring(0, 200));
        }

        const data = await response.json();
        let text = data.candidates[0].content.parts[0].text;
        text = text.replace(/```json/g, '').replace(/```/g, '').trim();
        
        const match = text.match(/\{[\s\S]*\}/);
        if (match) {
          const result = JSON.parse(match[0]);
          displayResults(result);
          showDebug('âœ… Analysis complete!');
        }
      } catch (e) {
        showError(e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Analyze Frame';
      }
    }

    function displayResults(data) {
      document.getElementById('results').classList.remove('hidden');
      document.getElementById('analysisText').textContent = data.analysis;
      
      let issuesHTML = '';
      data.issues?.forEach((issue, i) => {
        issuesHTML += `<div class="flex gap-3 mb-3"><span class="text-amber-400 font-bold">${i+1}.</span><span class="text-slate-300">${issue}</span></div>`;
      });
      document.getElementById('issuesList').innerHTML = issuesHTML;

      let drillsHTML = '';
      data.drills?.forEach((drill, i) => {
        let stepsHTML = '';
        drill.steps?.forEach((step, j) => {
          stepsHTML += `<div class="flex gap-2 mb-1"><span class="text-blue-400">${j+1}.</span><span class="text-slate-300 text-sm">${step}</span></div>`;
        });
        drillsHTML += `
          <div class="mb-6">
            <h3 class="font-bold text-blue-400 mb-1">${drill.name}</h3>
            <p class="text-sm text-slate-400 mb-2 italic">${drill.purpose}</p>
            ${stepsHTML}
            <p class="text-xs text-slate-500 mt-2">Practice: ${drill.frequency}</p>
          </div>
        `;
      });
      document.getElementById('drillsList').innerHTML = drillsHTML;
    }
  </script>
</body>
</html>